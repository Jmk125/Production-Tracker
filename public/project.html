<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Details - Payroll Tracker</title>
    <link rel="stylesheet" href="/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  </head>
<body>
  <header>
    <div class="container">
      <h1>üèóÔ∏è Payroll Tracker</h1>
      <nav>
        <a href="/">Projects</a>
        <a href="/comparison">Comparison</a>
      </nav>
    </div>
  </header>

  <div class="container">
    <div style="margin-bottom: 1rem;">
      <a href="/" style="color: var(--text-secondary); text-decoration: none;">‚Üê Back to Projects</a>
    </div>

    <div class="card" style="margin-bottom: 1.5rem;">
      <h2 id="projectName" style="margin-bottom: 0.5rem;">Loading...</h2>
      <div id="projectMeta" class="project-meta"></div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab(event, 'overview')">Overview</button>
      <button class="tab" onclick="switchTab(event, 'upload')">Upload Payroll</button>
      <button class="tab" onclick="switchTab(event, 'budget')">Budget</button>
      <button class="tab" onclick="switchTab(event, 'data')">Time Entries</button>
    </div>

    <!-- Overview Tab -->
    <div id="overviewTab" class="tab-content active">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Monthly Hours</h3>
          <div class="chart-controls">
            <select id="viewType" onchange="updateChart()">
              <option value="total">Total Hours</option>
              <option value="costCode">By Cost Code</option>
              <option value="costCodeDivision">By Cost Code Division</option>
              <option value="payClass">By Pay Class</option>
              <option value="job">By Job/Building</option>
              <option value="employee">By Employee</option>
            </select>
            <label style="display: inline-flex; align-items: center; gap: 0.35rem; font-size: 0.9rem; color: var(--text-secondary);">
              <input type="checkbox" id="stackToggle" checked onchange="updateChart()"> Stack bars
            </label>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="hoursChart"></canvas>
        </div>
      </div>

      <div class="grid grid-2" style="margin-top: 1.5rem;">
        <div class="card">
          <h3 class="card-title">Summary Statistics</h3>
          <div id="summaryStats" style="margin-top: 1rem;">
            Loading...
          </div>
        </div>

        <div class="card">
          <h3 class="card-title">Recent Uploads</h3>
          <div id="recentUploads" style="margin-top: 1rem;">
            Loading...
          </div>
        </div>
      </div>

      <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
          <h3 class="card-title">Budget Summary</h3>
          <div id="budgetMeta" style="color: var(--text-secondary); font-size: 0.9rem;">Loading budget...</div>
        </div>
        <div id="budgetSummary" style="margin-top: 1rem;">Loading budget...</div>
        <div class="grid grid-2" style="margin-top: 1.25rem; gap: 1.25rem;">
          <div class="chart-container" style="min-height: 320px;">
            <canvas id="budgetVarianceChart" aria-label="Budget variance by hours"></canvas>
          </div>
          <div class="chart-container" style="min-height: 320px;">
            <canvas id="budgetPercentChart" aria-label="Budget variance by percentage"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload Tab -->
    <div id="uploadTab" class="tab-content">
      <div class="card">
        <h3 class="card-title" style="margin-bottom: 1rem;">Upload Payroll PDF</h3>
        
        <div id="uploadArea" class="upload-area">
          <input type="file" id="fileInput" accept=".pdf" style="display: none;" onchange="handleFileSelect(event)">
          <p style="font-size: 1.125rem; margin-bottom: 0.5rem;">üìÑ Drop PDF file here or click to browse</p>
          <p style="color: var(--text-secondary); font-size: 0.875rem;">Upload payroll reports to extract time entry data</p>
        </div>

        <div id="uploadProgress" style="display: none; margin-top: 1rem;">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <div class="loading"></div>
            <span>Processing PDF...</span>
          </div>
        </div>

        <div id="uploadResult" style="margin-top: 1rem;"></div>

        <div style="margin-top: 2rem;">
          <h4 style="margin-bottom: 1rem;">Upload History</h4>
          <div id="uploadHistory"></div>
        </div>
      </div>
    </div>

    <!-- Budget Tab -->
    <div id="budgetTab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div>
            <h3 class="card-title" style="margin-bottom: 0.25rem;">Upload Budget Spreadsheet</h3>
            <p style="color: var(--text-secondary); font-size: 0.9rem;">Upload Excel files that include a Phase column and a Labor Hours column.</p>
          </div>
        </div>

        <div id="budgetUploadArea" class="upload-area">
          <input type="file" id="budgetFileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleBudgetFileSelect(event)">
          <p style="font-size: 1.125rem; margin-bottom: 0.5rem;">üìä Drop Excel budget here or click to browse</p>
          <p style="color: var(--text-secondary); font-size: 0.875rem;">We'll total the Labor Hours for each Phase cost code (decimals removed).</p>
        </div>

        <div id="budgetUploadProgress" style="display: none; margin-top: 1rem;">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <div class="loading"></div>
            <span>Processing budget...</span>
          </div>
        </div>

        <div id="budgetUploadResult" style="margin-top: 1rem;"></div>
      </div>

      <div class="card" style="margin-top: 1.25rem;">
        <div class="card-header">
          <h3 class="card-title">Budget Versions</h3>
          <div style="color: var(--text-secondary); font-size: 0.9rem;" id="budgetVersionMeta"></div>
        </div>
        <div id="budgetUploadHistory"></div>
      </div>

      <div class="card" style="margin-top: 1.25rem;">
        <div class="card-header">
          <h3 class="card-title">Cost Code Breakdown</h3>
          <div style="color: var(--text-secondary); font-size: 0.9rem;">Budget vs. time entry hours</div>
        </div>
        <div id="budgetBreakdown" style="margin-top: 1rem;"></div>
      </div>
    </div>

    <!-- Data Tab -->
    <div id="dataTab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Time Entries</h3>
          <div style="display: flex; gap: 0.5rem;">
            <input type="text" id="searchEntries" placeholder="Search..." style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
          </div>
        </div>
        <div style="overflow-x: auto;">
          <table id="entriesTable" style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 2px solid var(--border-color);">
                <th style="padding: 0.75rem; text-align: left;">Date</th>
                <th style="padding: 0.75rem; text-align: left;">Employee</th>
                <th style="padding: 0.75rem; text-align: left;">Pay Class</th>
                <th style="padding: 0.75rem; text-align: right;">Hours</th>
                <th style="padding: 0.75rem; text-align: left;">Cost Code</th>
                <th style="padding: 0.75rem; text-align: left;">Job</th>
              </tr>
            </thead>
            <tbody id="entriesTableBody">
              <tr>
                <td colspan="6" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                  Loading entries...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const projectId = window.location.pathname.split('/').pop();
    let projectData = null;
    let timeEntries = [];
    let detailedStats = [];
    let budgetData = null;
    let budgetComparison = [];
    let hoursChart = null;
    let payClassChart = null;
    let budgetVarianceChart = null;
    let budgetPercentChart = null;

    document.addEventListener('DOMContentLoaded', async () => {
      await loadProject();
      await loadTimeEntries();
      await loadDetailedStats();
      await loadBudgetData();
      await loadUploads();
      setupUploadArea();
      setupBudgetUploadArea();
      updateChart();
      renderSummaryStats();
    });

    async function loadProject() {
      try {
        const response = await fetch(`/api/projects/${projectId}`);
        projectData = await response.json();
        
        document.getElementById('projectName').textContent = projectData.name;
        
        const meta = [];
        if (projectData.size) meta.push(`üìè ${projectData.size} ${projectData.size_unit || ''}`);
        if (projectData.start_date) meta.push(`üìÖ ${formatDate(projectData.start_date)}`);
        if (projectData.end_date) meta.push(`üèÅ ${formatDate(projectData.end_date)}`);
        
        document.getElementById('projectMeta').innerHTML = meta.map(m => `<span>${m}</span>`).join('');
      } catch (error) {
        console.error('Error loading project:', error);
      }
    }

    async function loadTimeEntries() {
      try {
        const response = await fetch(`/api/projects/${projectId}/entries`);
        timeEntries = await response.json();
        renderTimeEntries();
      } catch (error) {
        console.error('Error loading time entries:', error);
      }
    }

    async function loadDetailedStats() {
      try {
        const response = await fetch(`/api/projects/${projectId}/stats/monthly-detail`);
        detailedStats = await response.json();
      } catch (error) {
        console.error('Error loading detailed stats:', error);
      }
    }

    async function loadBudgetData() {
      try {
        const response = await fetch(`/api/projects/${projectId}/budget`);
        budgetData = await response.json();
        budgetComparison = budgetData.comparison || [];

        renderBudgetSummary();
        renderBudgetUploads(budgetData.uploads || []);
        renderBudgetBreakdown();
        renderBudgetCharts();
      } catch (error) {
        console.error('Error loading budget data:', error);
        document.getElementById('budgetSummary').textContent = 'Unable to load budget data.';
      }
    }

    async function loadUploads() {
      try {
        const response = await fetch(`/api/projects/${projectId}/uploads`);
        const uploads = await response.json();
        renderUploads(uploads);
        renderRecentUploads(uploads);
      } catch (error) {
        console.error('Error loading uploads:', error);
      }
    }

    function renderTimeEntries() {
      const tbody = document.getElementById('entriesTableBody');
      
      if (timeEntries.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
              No time entries yet. Upload a payroll PDF to get started.
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = timeEntries.map(entry => `
        <tr style="border-bottom: 1px solid var(--border-color);">
          <td style="padding: 0.75rem;">${formatDate(entry.date)}</td>
          <td style="padding: 0.75rem;">${escapeHtml(entry.employee_name)}</td>
          <td style="padding: 0.75rem;">${entry.pay_class || '-'}</td>
          <td style="padding: 0.75rem; text-align: right;">${entry.hours.toFixed(2)}</td>
          <td style="padding: 0.75rem;">${entry.cost_code || '-'}</td>
          <td style="padding: 0.75rem; font-size: 0.813rem;">${entry.job_description || '-'}</td>
        </tr>
      `).join('');
    }

    function renderSummaryStats() {
      const totalHours = timeEntries.reduce((sum, entry) => sum + entry.hours, 0);
      const uniqueEmployees = new Set(timeEntries.map(e => e.employee_name)).size;
      const costCodes = new Set(timeEntries.map(e => e.cost_code).filter(Boolean)).size;

      const payClassTotals = timeEntries.reduce((acc, entry) => {
        const key = entry.pay_class || 'Unknown';
        acc[key] = (acc[key] || 0) + entry.hours;
        return acc;
      }, {});
      const payClassEntries = Object.entries(payClassTotals).sort((a, b) => b[1] - a[1]);

      const positiveHours = payClassEntries.map(([, hours]) => hours).filter(h => h > 0);
      const ratioBase = positiveHours.length ? Math.min(...positiveHours) : 0;
      const ratioText = ratioBase > 0
        ? payClassEntries.map(([name, hours]) => `${name}: ${Math.round(hours / ratioBase)}`).join(' ‚Ä¢ ')
        : 'No pay class hours available yet.';

      const dateRange = timeEntries.length > 0 ? {
        start: new Date(Math.min(...timeEntries.map(e => new Date(e.date)))),
        end: new Date(Math.max(...timeEntries.map(e => new Date(e.date))))
      } : null;

      document.getElementById('summaryStats').innerHTML = `
        <div style="display: grid; gap: 1rem;">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem;">
            <div>
              <div style="font-size: 1.875rem; font-weight: 700; color: var(--primary-color);">
                ${totalHours.toLocaleString(undefined, { maximumFractionDigits: 1 })}
              </div>
              <div style="color: var(--text-secondary); font-size: 0.875rem;">Total Hours</div>
            </div>
            <div>
              <div style="font-size: 1.875rem; font-weight: 700; color: var(--primary-color);">
                ${uniqueEmployees}
              </div>
              <div style="color: var(--text-secondary); font-size: 0.875rem;">Unique Employees</div>
            </div>
            <div>
              <div style="font-size: 1.875rem; font-weight: 700; color: var(--primary-color);">
                ${costCodes}
              </div>
              <div style="color: var(--text-secondary); font-size: 0.875rem;">Cost Codes</div>
            </div>
          </div>
          ${dateRange ? `
            <div style="margin-top: 0.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
              <div style="font-size: 0.875rem; color: var(--text-secondary);">
                ${formatDate(dateRange.start.toISOString().split('T')[0])} - ${formatDate(dateRange.end.toISOString().split('T')[0])}
              </div>
            </div>
          ` : ''}
          ${payClassEntries.length ? `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1.25rem; align-items: center;">
              <div style="display: grid; gap: 0.75rem;">
                <div style="font-weight: 600;">Hours by Pay Class</div>
                <div style="display: grid; gap: 0.5rem;">
                  ${payClassEntries.map(([name, hours]) => {
                    const percentage = totalHours > 0 ? (hours / totalHours) * 100 : 0;
                    return `
                      <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0.5rem; background: #f8fafc; border: 1px solid var(--border-color); border-radius: 0.35rem;">
                        <span style="font-weight: 600;">${escapeHtml(name)}</span>
                        <span style="font-size: 0.9rem; color: var(--text-secondary);">${hours.toFixed(2)} hrs (${percentage.toFixed(1)}%)</span>
                      </div>
                    `;
                  }).join('')}
                </div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);">Ratio (relative to smallest class): ${ratioText}</div>
              </div>
              <div style="min-height: 240px;">
                <canvas id="payClassChart" aria-label="Pay class doughnut chart"></canvas>
              </div>
            </div>
          ` : `<p style="color: var(--text-secondary);">No pay class data yet.</p>`}
        </div>
      `;

      if (payClassEntries.length) {
        renderPayClassChart(payClassEntries, totalHours);
      }
    }

    function renderUploads(uploads) {
      const container = document.getElementById('uploadHistory');
      
      if (uploads.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary);">No uploads yet</p>';
        return;
      }

      container.innerHTML = uploads.map(upload => `
        <div class="file-item">
          <div>
            <div style="font-weight: 500;">${escapeHtml(upload.filename)}</div>
            <div style="font-size: 0.813rem; color: var(--text-secondary);">
              ${new Date(upload.upload_date).toLocaleString()}
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderRecentUploads(uploads) {
      const container = document.getElementById('recentUploads');
      const recent = uploads.slice(0, 5);
      
      if (recent.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.875rem;">No uploads yet</p>';
        return;
      }

      container.innerHTML = recent.map(upload => `
        <div style="padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
          <div style="font-size: 0.875rem; font-weight: 500;">${escapeHtml(upload.filename)}</div>
          <div style="font-size: 0.75rem; color: var(--text-secondary);">
            ${new Date(upload.upload_date).toLocaleString()}
          </div>
        </div>
      `).join('');
    }

    function renderBudgetUploads(uploads) {
      const container = document.getElementById('budgetUploadHistory');
      const meta = document.getElementById('budgetVersionMeta');

      if (!uploads || uploads.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary);">No budget uploads yet</p>';
        if (meta) meta.textContent = 'No budget uploads yet';
        return;
      }

      if (meta) {
        const latest = uploads[0];
        meta.textContent = `Latest: ${escapeHtml(latest.filename)} ‚Ä¢ ${new Date(latest.upload_date).toLocaleString()} (${uploads.length} total)`;
      }

      container.innerHTML = uploads.map(upload => `
        <div class="file-item">
          <div>
            <div style="font-weight: 500;">${escapeHtml(upload.filename)}</div>
            <div style="font-size: 0.813rem; color: var(--text-secondary);">
              ${new Date(upload.upload_date).toLocaleString()}
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderBudgetSummary() {
      const summaryEl = document.getElementById('budgetSummary');
      const metaEl = document.getElementById('budgetMeta');

      if (!summaryEl || !metaEl) return;

      if (!budgetData || !budgetData.latest) {
        metaEl.textContent = 'No budget uploaded yet';
        summaryEl.innerHTML = '<p style="color: var(--text-secondary);">Upload a budget spreadsheet to compare against time entries.</p>';
        return;
      }

      const latest = budgetData.latest;
      metaEl.textContent = `Latest: ${escapeHtml(latest.filename)} ‚Ä¢ ${new Date(latest.upload_date).toLocaleString()}`;

      const totalBudgetHours = Object.values(latest.cost_code_hours || {}).reduce((sum, val) => sum + Number(val || 0), 0);
      const totalActualHours = budgetComparison.reduce((sum, row) => sum + (row.actual_hours || 0), 0);
      const totalVariance = totalActualHours - totalBudgetHours;

      const mostVariance = [...budgetComparison]
        .sort((a, b) => Math.abs(b.variance_hours) - Math.abs(a.variance_hours))
        .slice(0, 8);

      summaryEl.innerHTML = `
        <div style="display: grid; gap: 1rem;">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem;">
            <div>
              <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">${formatHours(totalBudgetHours)}</div>
              <div style="color: var(--text-secondary); font-size: 0.9rem;">Budgeted Hours</div>
            </div>
            <div>
              <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">${formatHours(totalActualHours)}</div>
              <div style="color: var(--text-secondary); font-size: 0.9rem;">Hours Spent</div>
            </div>
            <div>
              <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">${formatHours(totalVariance)}</div>
              <div style="color: var(--text-secondary); font-size: 0.9rem;">Variance (hrs)</div>
            </div>
          </div>
          ${mostVariance.length ? `
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="border-bottom: 2px solid var(--border-color);">
                    <th style="text-align: left; padding: 0.5rem;">Cost Code</th>
                    <th style="text-align: right; padding: 0.5rem;">Budget</th>
                    <th style="text-align: right; padding: 0.5rem;">Spent</th>
                    <th style="text-align: right; padding: 0.5rem;">Variance</th>
                    <th style="text-align: right; padding: 0.5rem;">% Variance</th>
                  </tr>
                </thead>
                <tbody>
                  ${mostVariance.map(row => `
                    <tr style="border-bottom: 1px solid var(--border-color);">
                      <td style="padding: 0.5rem; font-weight: 600;">${escapeHtml(row.cost_code)}</td>
                      <td style="padding: 0.5rem; text-align: right;">${formatHours(row.budget_hours)}</td>
                      <td style="padding: 0.5rem; text-align: right;">${formatHours(row.actual_hours)}</td>
                      <td style="padding: 0.5rem; text-align: right;">${formatVarianceBadge(row.variance_hours)}</td>
                      <td style="padding: 0.5rem; text-align: right;">${formatPercentVariance(row.variance_percent)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          ` : '<p style="color: var(--text-secondary);">No budget variance to display yet.</p>'}
        </div>
      `;
    }

    function renderBudgetBreakdown() {
      const container = document.getElementById('budgetBreakdown');
      if (!container) return;

      if (!budgetData || !budgetData.latest) {
        container.innerHTML = '<p style="color: var(--text-secondary);">Upload a budget and add time entries to see the breakdown.</p>';
        return;
      }

      const rows = [...budgetComparison].sort((a, b) => a.cost_code.localeCompare(b.cost_code));

      container.innerHTML = `
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 2px solid var(--border-color);">
                <th style="text-align: left; padding: 0.6rem;">Cost Code</th>
                <th style="text-align: right; padding: 0.6rem;">Budget Hours</th>
                <th style="text-align: right; padding: 0.6rem;">Hours Spent</th>
                <th style="text-align: right; padding: 0.6rem;">Variance (hrs)</th>
                <th style="text-align: right; padding: 0.6rem;">Variance (%)</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map(row => `
                <tr style="border-bottom: 1px solid var(--border-color);">
                  <td style="padding: 0.6rem; font-weight: 600;">${escapeHtml(row.cost_code)}</td>
                  <td style="padding: 0.6rem; text-align: right;">${formatHours(row.budget_hours)}</td>
                  <td style="padding: 0.6rem; text-align: right;">${formatHours(row.actual_hours)}</td>
                  <td style="padding: 0.6rem; text-align: right;">${formatVarianceBadge(row.variance_hours)}</td>
                  <td style="padding: 0.6rem; text-align: right;">${formatPercentVariance(row.variance_percent)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderBudgetCharts() {
      const varianceCanvas = document.getElementById('budgetVarianceChart');
      const percentCanvas = document.getElementById('budgetPercentChart');

      if (budgetVarianceChart) budgetVarianceChart.destroy();
      if (budgetPercentChart) budgetPercentChart.destroy();

      if (!budgetData || !budgetData.latest || !budgetComparison.length) return;

      const varianceData = [...budgetComparison]
        .sort((a, b) => Math.abs(b.variance_hours) - Math.abs(a.variance_hours))
        .slice(0, 10);

      if (varianceCanvas && varianceData.length) {
        const labels = varianceData.map(row => row.cost_code);
        const values = varianceData.map(row => row.variance_hours);
        const colors = values.map(v => v >= 0 ? 'rgba(239, 68, 68, 0.8)' : 'rgba(34, 197, 94, 0.8)');

        budgetVarianceChart = new Chart(varianceCanvas, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Variance (hrs)',
              data: values,
              backgroundColor: colors,
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: { beginAtZero: true, title: { display: true, text: 'Hours' } }
            }
          }
        });
      }

      const percentData = budgetComparison
        .filter(row => row.variance_percent !== null && Number.isFinite(row.variance_percent))
        .sort((a, b) => Math.abs(b.variance_percent) - Math.abs(a.variance_percent))
        .slice(0, 10);

      if (percentCanvas && percentData.length) {
        const labels = percentData.map(row => row.cost_code);
        const values = percentData.map(row => row.variance_percent);
        const colors = values.map(v => v >= 0 ? 'rgba(239, 68, 68, 0.8)' : 'rgba(34, 197, 94, 0.8)');

        budgetPercentChart = new Chart(percentCanvas, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Variance (%)',
              data: values,
              backgroundColor: colors,
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: { beginAtZero: true, title: { display: true, text: 'Percent' } }
            }
          }
        });
      }
    }

    function updateChart() {
      const viewType = document.getElementById('viewType').value;
      const stacked = document.getElementById('stackToggle').checked;
      const ctx = document.getElementById('hoursChart');
      
      if (hoursChart) {
        hoursChart.destroy();
      }

      let chartData;
      
      if (viewType === 'total') {
        chartData = aggregateByMonth(detailedStats);
      } else if (viewType === 'costCode') {
        chartData = aggregateByCategory(detailedStats, 'cost_code');
      } else if (viewType === 'costCodeDivision') {
        chartData = aggregateByCategory(detailedStats, 'cost_code', formatCostCodeDivision);
      } else if (viewType === 'payClass') {
        chartData = aggregateByCategory(detailedStats, 'pay_class');
      } else if (viewType === 'job') {
        chartData = aggregateByCategory(detailedStats, 'job_description');
      } else if (viewType === 'employee') {
        chartData = aggregateByCategory(detailedStats, 'employee_name');
      }

      hoursChart = new Chart(ctx, {
        type: 'bar',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: viewType !== 'total'
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          },
          scales: {
            x: {
              stacked,
              grid: {
                display: false
              }
            },
            y: {
              stacked,
              beginAtZero: true,
              title: {
                display: true,
                text: 'Hours'
              }
            }
          }
        }
      });
    }

    function aggregateByMonth(data) {
      const monthlyTotals = {};
      
      data.forEach(entry => {
        if (!monthlyTotals[entry.month]) {
          monthlyTotals[entry.month] = 0;
        }
        monthlyTotals[entry.month] += entry.total_hours;
      });

      const months = Object.keys(monthlyTotals).sort();
      const hours = months.map(m => monthlyTotals[m]);

      return {
        labels: months.map(formatMonth),
        datasets: [{
          label: 'Total Hours',
          data: hours,
          backgroundColor: 'rgba(37, 99, 235, 0.8)',
          borderColor: 'rgba(37, 99, 235, 1)',
          borderWidth: 1
        }]
      };
    }

    function aggregateByCategory(data, category, transformer = null) {
      const monthlyData = {};
      const categories = new Set();

      data.forEach(entry => {
        const rawValue = entry[category];
        const cat = transformer ? transformer(rawValue) : (rawValue || 'Unknown');
        categories.add(cat);
        
        if (!monthlyData[entry.month]) {
          monthlyData[entry.month] = {};
        }
        if (!monthlyData[entry.month][cat]) {
          monthlyData[entry.month][cat] = 0;
        }
        monthlyData[entry.month][cat] += entry.total_hours;
      });

      const months = Object.keys(monthlyData).sort();
      const colors = generateColors(categories.size);
      
      const datasets = Array.from(categories).map((cat, index) => ({
        label: cat,
        data: months.map(month => monthlyData[month][cat] || 0),
        backgroundColor: colors[index],
        borderWidth: 0
      }));

      return {
        labels: months.map(formatMonth),
        datasets
      };
    }

    function formatCostCodeDivision(costCode) {
      if (!costCode) return 'Unknown';
      const trimmed = costCode.toString().trim();
      if (trimmed.length < 2) return trimmed || 'Unknown';
      return `${trimmed.slice(0, 2)} Division`;
    }

    function generateColors(count) {
      const colors = [
        'rgba(37, 99, 235, 0.8)',
        'rgba(34, 197, 94, 0.8)',
        'rgba(234, 179, 8, 0.8)',
        'rgba(239, 68, 68, 0.8)',
        'rgba(168, 85, 247, 0.8)',
        'rgba(236, 72, 153, 0.8)',
        'rgba(14, 165, 233, 0.8)',
        'rgba(251, 146, 60, 0.8)',
        'rgba(132, 204, 22, 0.8)',
        'rgba(249, 115, 22, 0.8)'
      ];
      
      while (colors.length < count) {
        colors.push(`rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 0.8)`);
      }

      return colors;
    }

    function renderPayClassChart(payClassEntries, totalHours) {
      const ctx = document.getElementById('payClassChart');
      if (!ctx) return;

      if (payClassChart) {
        payClassChart.destroy();
      }

      const labels = payClassEntries.map(([name]) => name);
      const data = payClassEntries.map(([, hours]) => hours);
      const colors = generateColors(labels.length);

      payClassChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: colors,
            borderWidth: 0
          }]
        },
        options: {
          plugins: {
            tooltip: {
              callbacks: {
                label: (context) => {
                  const hours = context.raw || 0;
                  const percent = totalHours > 0 ? (hours / totalHours) * 100 : 0;
                  return `${context.label}: ${hours.toFixed(2)} hrs (${percent.toFixed(1)}%)`;
                }
              }
            },
            legend: {
              position: 'bottom'
            }
          },
          cutout: '55%'
        }
      });
    }

    function setupUploadArea() {
      const uploadArea = document.getElementById('uploadArea');
      const fileInput = document.getElementById('fileInput');

      uploadArea.addEventListener('click', () => fileInput.click());

      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type === 'application/pdf') {
          uploadFile(files[0]);
        } else {
          alert('Please drop a PDF file');
        }
      });
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        uploadFile(file);
      }
    }

    async function uploadFile(file) {
      const formData = new FormData();
      formData.append('payroll', file);

      const progressDiv = document.getElementById('uploadProgress');
      const resultDiv = document.getElementById('uploadResult');
      
      progressDiv.style.display = 'block';
      resultDiv.innerHTML = '';

      try {
        const response = await fetch(`/api/projects/${projectId}/upload`, {
          method: 'POST',
          body: formData
        });

        const result = await response.json();
        progressDiv.style.display = 'none';

        if (response.ok) {
          resultDiv.innerHTML = `
            <div class="alert alert-success">
              ‚úì Successfully processed ${result.entriesInserted} time entries from ${result.entriesFound} found in the PDF
            </div>
          `;
          
          // Reload data
          await loadTimeEntries();
          await loadDetailedStats();
          await loadBudgetData();
          await loadUploads();
          updateChart();
          renderSummaryStats();
          
          // Reset file input
          document.getElementById('fileInput').value = '';
        } else {
          resultDiv.innerHTML = `
            <div class="alert alert-error">
              ‚úó Error: ${result.error || 'Failed to upload file'}
            </div>
          `;
        }
      } catch (error) {
        progressDiv.style.display = 'none';
        resultDiv.innerHTML = `
          <div class="alert alert-error">
            ‚úó Error uploading file: ${error.message}
          </div>
        `;
      }
    }

    function setupBudgetUploadArea() {
      const uploadArea = document.getElementById('budgetUploadArea');
      const fileInput = document.getElementById('budgetFileInput');

      if (!uploadArea || !fileInput) return;

      uploadArea.addEventListener('click', () => fileInput.click());

      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0 && isExcelFile(files[0])) {
          uploadBudgetFile(files[0]);
        } else {
          alert('Please drop an Excel file (.xlsx or .xls)');
        }
      });
    }

    function handleBudgetFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        uploadBudgetFile(file);
      }
    }

    function isExcelFile(file) {
      const acceptedTypes = [
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'application/vnd.ms-excel'
      ];
      return acceptedTypes.includes(file.type) || file.name.endsWith('.xlsx') || file.name.endsWith('.xls');
    }

    async function uploadBudgetFile(file) {
      const progressDiv = document.getElementById('budgetUploadProgress');
      const resultDiv = document.getElementById('budgetUploadResult');

      progressDiv.style.display = 'block';
      resultDiv.innerHTML = '';

      try {
        const costCodeHours = await parseBudgetFile(file);

        const response = await fetch(`/api/projects/${projectId}/budget`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename: file.name, costCodeHours })
        });

        const result = await response.json();
        progressDiv.style.display = 'none';

        if (response.ok) {
          budgetData = result;
          budgetComparison = result.comparison || [];
          renderBudgetSummary();
          renderBudgetUploads(result.uploads || []);
          renderBudgetBreakdown();
          renderBudgetCharts();

          resultDiv.innerHTML = `
            <div class="alert alert-success">
              ‚úì Processed ${result.codesTracked} cost codes from ${escapeHtml(file.name)}
            </div>
          `;

          document.getElementById('budgetFileInput').value = '';
        } else {
          resultDiv.innerHTML = `
            <div class="alert alert-error">
              ‚úó Error: ${result.error || 'Failed to save budget'}
            </div>
          `;
        }
      } catch (error) {
        progressDiv.style.display = 'none';
        resultDiv.innerHTML = `
          <div class="alert alert-error">
            ‚úó Error processing budget: ${error.message}
          </div>
        `;
      }
    }

    async function parseBudgetFile(file) {
      if (typeof XLSX === 'undefined') {
        throw new Error('Spreadsheet parser not available.');
      }

      const buffer = await file.arrayBuffer();
      const workbook = XLSX.read(buffer, { type: 'array' });
      const firstSheet = workbook.SheetNames[0];
      const sheet = workbook.Sheets[firstSheet];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

      if (!rows.length) {
        throw new Error('The spreadsheet is empty.');
      }

      const headerRow = rows[0].map(cell => cell.toString().trim().toLowerCase());
      const phaseIndex = headerRow.findIndex(h => h === 'phase');
      const hoursIndex = headerRow.findIndex(h => h === 'labor hours');

      if (phaseIndex === -1) {
        throw new Error('Could not find a "Phase" column.');
      }

      if (hoursIndex === -1) {
        throw new Error('Could not find a "Labor Hours" column.');
      }

      const totals = {};
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (!row || row.length <= hoursIndex) continue;
        const rawPhase = row[phaseIndex];
        const hours = parseFloat(row[hoursIndex]);
        const normalizedCode = normalizeCostCodeClient(rawPhase);

        if (!normalizedCode || !Number.isFinite(hours)) continue;

        totals[normalizedCode] = (totals[normalizedCode] || 0) + hours;
      }

        if (Object.keys(totals).length === 0) {
          throw new Error('No cost codes with Labor Hours values were found.');
        }

      return totals;
    }

    function switchTab(evt, tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      if (evt && evt.target) {
        evt.target.classList.add('active');
      }

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName + 'Tab').classList.add('active');
    }

    function normalizeCostCodeClient(code) {
      if (code === undefined || code === null) return null;
      return code.toString().replace(/\./g, '').trim() || null;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr + 'T00:00:00');
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function formatMonth(monthStr) {
      const [year, month] = monthStr.split('-');
      const date = new Date(year, month - 1);
      return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
    }

    function formatHours(value) {
      return Number(value || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatVarianceBadge(value) {
      const sign = value > 0 ? '+' : '';
      const color = value > 0 ? '#ef4444' : value < 0 ? '#22c55e' : '#0f172a';
      return `<span style="font-weight: 700; color: ${color};">${sign}${Number(value || 0).toFixed(2)}</span>`;
    }

    function formatPercentVariance(value) {
      if (value === null || value === undefined || Number.isNaN(value)) return '‚Äî';
      const sign = value > 0 ? '+' : '';
      return `${sign}${value.toFixed(1)}%`;
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Search functionality
    document.getElementById('searchEntries').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#entriesTableBody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });
  </script>
</body>
</html>
