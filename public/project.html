<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Details - Production Tracker</title>
    <link rel="stylesheet" href="/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  </head>
<body>
  <header>
    <div class="container">
      <h1>üèóÔ∏è Production Tracker</h1>
      <nav>
        <a href="/">Projects</a>
        <a href="/comparison">Comparison</a>
      </nav>
    </div>
  </header>

  <div class="container">
    <div style="margin-bottom: 1rem;">
      <a href="/" style="color: var(--text-secondary); text-decoration: none;">‚Üê Back to Projects</a>
    </div>

    <div class="card" style="margin-bottom: 1.5rem;">
      <h2 id="projectName" style="margin-bottom: 0.5rem;">Loading...</h2>
      <div id="projectMeta" class="project-meta"></div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab(event, 'overview')">Overview</button>
      <button class="tab" onclick="switchTab(event, 'upload')">Upload Payroll</button>
      <button class="tab" onclick="switchTab(event, 'budget')">Budget</button>
      <button class="tab" onclick="switchTab(event, 'data')">Time Entries</button>
    </div>

    <!-- Overview Tab -->
    <div id="overviewTab" class="tab-content active">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Monthly Hours</h3>
          <div class="chart-controls">
            <select id="viewType" onchange="updateChart()">
              <option value="total">Total Hours</option>
              <option value="costCode">By Cost Code</option>
              <option value="costCodeDivision">By Cost Code Division</option>
              <option value="payClass">By Pay Class</option>
              <option value="job">By Job/Building</option>
              <option value="employee">By Employee</option>
            </select>
            <label style="display: inline-flex; align-items: center; gap: 0.35rem; font-size: 0.9rem; color: var(--text-secondary);">
              <input type="checkbox" id="stackToggle" checked onchange="updateChart()"> Stack bars
            </label>
            <label style="display: inline-flex; align-items: center; gap: 0.35rem; font-size: 0.9rem; color: var(--text-secondary);">
              <input type="checkbox" id="applyFiltersToggle" checked onchange="updateChart()"> Apply filters
            </label>
          </div>
        </div>
        <div id="filterPanel" class="filter-bar" style="display: none;">
          <div class="filter-section">
            <div class="filter-section-header">
              <div>
                <div class="filter-title">Cost codes</div>
                <div class="filter-subtitle">Choose which cost codes feed the chart</div>
              </div>
              <button class="collapse-toggle" type="button" onclick="toggleFilterSection('costCodeSection', this)">Hide</button>
            </div>
            <div id="costCodeSection" class="filter-section-body">
              <div class="filter-actions">
                <label class="checkbox">
                  <input type="checkbox" id="costCodeAllToggle" checked onchange="toggleAllCostCodes(event)"> All cost codes
                </label>
                <label class="checkbox">
                  <input type="checkbox" id="costCode09Toggle" checked onchange="toggleDivisionCostCodes(event, ['09'])"> 09 division
                </label>
                <label class="checkbox">
                  <input type="checkbox" id="costCode06GroupToggle" checked onchange="toggleDivisionCostCodes(event, ['06','08','10','11','12'])"> 06 + 08/10/11/12 divisions
                </label>
              </div>
              <div id="costCodeList" class="filter-list"></div>
            </div>
          </div>
          <div class="filter-section">
            <div class="filter-section-header">
              <div>
                <div class="filter-title">Buildings</div>
                <div class="filter-subtitle">Select which jobs/buildings to include</div>
              </div>
              <button class="collapse-toggle" type="button" onclick="toggleFilterSection('jobSection', this)">Hide</button>
            </div>
            <div id="jobSection" class="filter-section-body">
              <div class="filter-actions">
                <label class="checkbox">
                  <input type="checkbox" id="jobAllToggle" checked onchange="toggleAllJobs(event)"> All jobs/buildings
                </label>
              </div>
              <div id="jobList" class="filter-list"></div>
            </div>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="hoursChart"></canvas>
        </div>
      </div>

      <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header" style="align-items: flex-start;">
          <div>
            <h3 class="card-title">Monthly Employees</h3>
            <div id="employeeChartSubtitle" style="color: var(--text-secondary); font-size: 0.9rem;">Unique employees working each month</div>
          </div>
          <div class="chart-controls">
            <label for="employeeMetric" style="font-size: 0.9rem; color: var(--text-secondary);">View</label>
            <select id="employeeMetric" onchange="renderEmployeeChart()">
              <option value="unique" selected>Unique employees</option>
              <option value="average">Average daily crew size</option>
            </select>
            <label style="display: inline-flex; align-items: center; gap: 0.35rem; font-size: 0.9rem; color: var(--text-secondary);">
              <input type="checkbox" id="employeeApplyFiltersToggle" onchange="renderEmployeeChart()"> Apply monthly hours filters
            </label>
          </div>
        </div>
        <div class="chart-container" style="min-height: 320px;">
          <canvas id="employeeChart" aria-label="Employees per month"></canvas>
          <div id="employeeChartEmptyState" style="display: none; color: var(--text-secondary); text-align: center; padding: 2rem;">
            No employee data yet.
          </div>
        </div>
      </div>

      <div class="grid grid-2" style="margin-top: 1.5rem;">
        <div class="card">
          <h3 class="card-title">Summary Statistics</h3>
          <div id="summaryStats" style="margin-top: 1rem;">
            Loading...
          </div>
        </div>

        <div class="card">
          <h3 class="card-title">Recent Uploads</h3>
          <div id="recentUploads" style="margin-top: 1rem;">
            Loading...
          </div>
        </div>
      </div>

      <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
          <h3 class="card-title">Budget Summary</h3>
          <div id="budgetMeta" style="color: var(--text-secondary); font-size: 0.9rem;">Loading budget...</div>
        </div>
        <div id="budgetSummary" style="margin-top: 1rem;">Loading budget...</div>
        <div id="areaVarianceSummary" style="margin-top: 1.25rem;"></div>
        <div class="chart-controls" style="align-items: center; margin-top: 1.25rem; justify-content: space-between;">
          <div style="color: var(--text-secondary); font-size: 0.9rem;">Show variance by hours or percent for all cost codes</div>
          <div style="display: inline-flex; gap: 0.5rem; align-items: center;">
            <label for="budgetChartMode" style="font-size: 0.9rem; color: var(--text-secondary);">Display</label>
            <select id="budgetChartMode" onchange="renderBudgetCharts()">
              <option value="hours">Variance (hours)</option>
              <option value="percent">Variance (%)</option>
            </select>
          </div>
        </div>
        <div class="chart-container" style="min-height: 420px;">
          <canvas id="budgetVarianceChart" aria-label="Budget variance chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Upload Tab -->
    <div id="uploadTab" class="tab-content">
      <div class="card">
        <h3 class="card-title" style="margin-bottom: 1rem;">Upload Payroll PDF</h3>
        
        <div id="uploadArea" class="upload-area">
          <input type="file" id="fileInput" accept=".pdf" style="display: none;" onchange="handleFileSelect(event)">
          <p style="font-size: 1.125rem; margin-bottom: 0.5rem;">üìÑ Drop PDF file here or click to browse</p>
          <p style="color: var(--text-secondary); font-size: 0.875rem;">Upload payroll reports to extract time entry data</p>
        </div>

        <div id="uploadProgress" style="display: none; margin-top: 1rem;">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <div class="loading"></div>
            <span>Processing PDF...</span>
          </div>
        </div>

        <div id="uploadResult" style="margin-top: 1rem;"></div>

        <div style="margin-top: 2rem;">
          <h4 style="margin-bottom: 1rem;">Upload History</h4>
          <div id="uploadHistory"></div>
        </div>
      </div>
    </div>

    <!-- Budget Tab -->
    <div id="budgetTab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div>
            <h3 class="card-title" style="margin-bottom: 0.25rem;">Upload Budget Spreadsheet</h3>
            <p style="color: var(--text-secondary); font-size: 0.9rem;">We'll read cost codes from column B and labor hours from column I, then total by cost code.</p>
          </div>
        </div>

        <div id="budgetUploadArea" class="upload-area">
          <input type="file" id="budgetFileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleBudgetFileSelect(event)">
          <p style="font-size: 1.125rem; margin-bottom: 0.5rem;">üìä Drop Excel budget here or click to browse</p>
          <p style="color: var(--text-secondary); font-size: 0.875rem;">Excel files with cost codes in column D and hours in column K.</p>
        </div>

        <div id="budgetUploadProgress" style="display: none; margin-top: 1rem;">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <div class="loading"></div>
            <span>Processing budget...</span>
          </div>
        </div>

        <div id="budgetUploadResult" style="margin-top: 1rem;"></div>
      </div>

      <div class="card" style="margin-top: 1.25rem;">
        <div class="card-header">
          <h3 class="card-title">Budget Versions</h3>
          <div style="color: var(--text-secondary); font-size: 0.9rem;" id="budgetVersionMeta"></div>
        </div>
        <div id="budgetUploadHistory"></div>
      </div>

      <div class="card" style="margin-top: 1.25rem;">
        <div class="card-header" style="align-items: flex-start;">
          <div>
            <h3 class="card-title" style="margin-bottom: 0.25rem;">Buildings / Areas</h3>
            <p style="color: var(--text-secondary); font-size: 0.9rem;">Match budget areas to payroll jobs and make manual hour adjustments when needed.</p>
          </div>
          <button class="chip" type="button" onclick="loadAreaData()">Refresh</button>
        </div>

        <div class="grid area-layout">
          <div>
            <h4 style="margin-bottom: 0.5rem;">Budget ‚Üí Payroll matching</h4>
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.75rem;">We suggest matches automatically, but you can pick the payroll job to tie each budget area to.</p>
            <div id="areaMappingList"></div>
          </div>

          <div>
            <h4 style="margin-bottom: 0.5rem;">Hours by building/job</h4>
            <div id="areaComparison" style="margin-top: 0.25rem;"></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top: 1.25rem;">
        <div class="card-header">
          <h3 class="card-title">Cost Code Breakdown</h3>
          <div style="color: var(--text-secondary); font-size: 0.9rem;">Budget vs. time entry hours</div>
        </div>
        <div id="budgetBreakdown" style="margin-top: 1rem;"></div>
      </div>
    </div>

    <!-- Data Tab -->
    <div id="dataTab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Time Entries</h3>
          <div style="display: flex; gap: 0.5rem;">
            <input type="text" id="searchEntries" placeholder="Search..." style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
          </div>
        </div>
        <div style="overflow-x: auto;">
          <table id="entriesTable" style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 2px solid var(--border-color);">
                <th style="padding: 0.75rem; text-align: left;">Date</th>
                <th style="padding: 0.75rem; text-align: left;">Employee</th>
                <th style="padding: 0.75rem; text-align: left;">Pay Class</th>
                <th style="padding: 0.75rem; text-align: right;">Hours</th>
                <th style="padding: 0.75rem; text-align: left;">Cost Code</th>
                <th style="padding: 0.75rem; text-align: left;">Job</th>
              </tr>
            </thead>
            <tbody id="entriesTableBody">
              <tr>
                <td colspan="6" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                  Loading entries...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const projectId = window.location.pathname.split('/').pop();
    let projectData = null;
    let timeEntries = [];
    let detailedStats = [];
    let monthlyStats = [];
    let costCodeList = [];
    let selectedCostCodes = new Set();
    let jobList = [];
    let selectedJobs = new Set();
    let budgetData = null;
    let budgetComparison = [];
    let areaData = { comparison: [], budgetAreas: [], actualAreas: [], mappings: {}, adjustments: { budget: {}, actual: {} } };
    let budgetSort = { column: 'variance_hours', direction: 'desc' };
    let hoursChart = null;
    let payClassChart = null;
    let budgetChart = null;
    let employeeChart = null;

    document.addEventListener('DOMContentLoaded', async () => {
      await loadProject();
      await loadTimeEntries();
      await loadDetailedStats();
      await loadMonthlyStats();
      await loadBudgetData();
      await loadAreaData();
      await loadUploads();
      setupUploadArea();
      setupBudgetUploadArea();
      updateChart();
      renderSummaryStats();
    });

    async function loadProject() {
      try {
        const response = await fetch(`/api/projects/${projectId}`);
        projectData = await response.json();
        
        document.getElementById('projectName').textContent = projectData.name;
        
        const meta = [];
        if (projectData.size) meta.push(`üìè ${projectData.size} ${projectData.size_unit || ''}`);
        if (projectData.start_date) meta.push(`üìÖ ${formatDate(projectData.start_date)}`);
        if (projectData.end_date) meta.push(`üèÅ ${formatDate(projectData.end_date)}`);
        
        document.getElementById('projectMeta').innerHTML = meta.map(m => `<span>${m}</span>`).join('');
      } catch (error) {
        console.error('Error loading project:', error);
      }
    }

    async function loadTimeEntries() {
      try {
        const response = await fetch(`/api/projects/${projectId}/entries`);
        timeEntries = await response.json();
        renderTimeEntries();
      } catch (error) {
        console.error('Error loading time entries:', error);
      }
    }

    async function loadDetailedStats() {
      try {
        const response = await fetch(`/api/projects/${projectId}/stats/monthly-detail`);
        detailedStats = await response.json();
        initializeCostCodeFilters();
        initializeJobFilters();
      } catch (error) {
        console.error('Error loading detailed stats:', error);
      }
    }

    async function loadMonthlyStats() {
      try {
        const response = await fetch(`/api/projects/${projectId}/stats/monthly`);
        monthlyStats = await response.json();
        renderEmployeeChart();
      } catch (error) {
        console.error('Error loading monthly stats:', error);
      }
    }

    async function loadBudgetData() {
      try {
        const response = await fetch(`/api/projects/${projectId}/budget`);
        budgetData = await response.json();
        budgetComparison = budgetData.comparison || [];
        areaData = budgetData.areaComparison || areaData;

        renderBudgetSummary();
        renderBudgetUploads(budgetData.uploads || []);
        renderBudgetBreakdown();
        renderBudgetCharts();
        renderAreaSection();
      } catch (error) {
        console.error('Error loading budget data:', error);
        document.getElementById('budgetSummary').textContent = 'Unable to load budget data.';
      }
    }

    async function loadAreaData() {
      try {
        const response = await fetch(`/api/projects/${projectId}/areas`);
        if (response.ok) {
          areaData = await response.json();
          renderAreaSection();
        }
      } catch (error) {
        console.error('Error loading area data:', error);
      }
    }

    async function loadUploads() {
      try {
        const response = await fetch(`/api/projects/${projectId}/uploads`);
        const uploads = await response.json();
        renderUploads(uploads);
        renderRecentUploads(uploads);
      } catch (error) {
        console.error('Error loading uploads:', error);
      }
    }

    function initializeCostCodeFilters() {
      const uniqueCodes = new Set();

      detailedStats.forEach(entry => {
        const normalized = normalizeCostCodeLabel(entry.cost_code);
        if (normalized) {
          uniqueCodes.add(normalized);
        }
      });

      costCodeList = Array.from(uniqueCodes).sort();
      selectedCostCodes = new Set(costCodeList);

      renderCostCodeList();
      updateCostCodeMasterCheckboxes();
      toggleFilterPanelVisibility(true);
    }

    function initializeJobFilters() {
      const uniqueJobs = new Set();

      detailedStats.forEach(entry => {
        const normalized = normalizeJobLabel(entry.job_description);
        if (normalized) {
          uniqueJobs.add(normalized);
        }
      });

      jobList = Array.from(uniqueJobs).sort((a, b) => a.localeCompare(b));
      selectedJobs = new Set(jobList);

      renderJobList();
      updateJobMasterCheckboxes();
      toggleFilterPanelVisibility(true);
    }

    function renderCostCodeList() {
      const list = document.getElementById('costCodeList');
      if (!list) return;

      if (!costCodeList.length) {
        list.innerHTML = '<div class="empty-filter">No cost codes available.</div>';
        return;
      }

      list.innerHTML = '';

      costCodeList.forEach(code => {
        const label = document.createElement('label');
        label.className = 'checkbox chip';
        label.title = `Toggle ${code}`;

        const input = document.createElement('input');
        input.type = 'checkbox';
        input.value = code;
        input.checked = selectedCostCodes.has(code);
        input.addEventListener('change', handleCostCodeToggle);

        label.appendChild(input);
        label.appendChild(document.createTextNode(` ${code}`));

        list.appendChild(label);
      });
    }

    function toggleFilterPanelVisibility(show = true) {
      const container = document.getElementById('filterPanel');
      if (!container) return;

      const hasFilters = costCodeList.length || jobList.length;
      container.style.display = show && hasFilters ? 'flex' : 'none';
    }

    function handleCostCodeToggle(event) {
      const code = event.target.value;
      if (event.target.checked) {
        selectedCostCodes.add(code);
      } else {
        selectedCostCodes.delete(code);
      }

      updateCostCodeMasterCheckboxes();
      updateChart();
    }

    function toggleAllCostCodes(event) {
      const shouldSelectAll = event.target.checked;

      if (shouldSelectAll) {
        selectedCostCodes = new Set(costCodeList);
      } else {
        selectedCostCodes.clear();
      }

      renderCostCodeList();
      updateCostCodeMasterCheckboxes();
      updateChart();
    }

    function toggleDivisionCostCodes(event, prefixes) {
      const shouldSelect = event.target.checked;

      costCodeList.forEach(code => {
        if (prefixes.some(prefix => code.startsWith(prefix))) {
          if (shouldSelect) {
            selectedCostCodes.add(code);
          } else {
            selectedCostCodes.delete(code);
          }
        }
      });

      renderCostCodeList();
      updateCostCodeMasterCheckboxes();
      updateChart();
    }

    function updateCostCodeMasterCheckboxes() {
      const allToggle = document.getElementById('costCodeAllToggle');
      const toggle09 = document.getElementById('costCode09Toggle');
      const toggle06Group = document.getElementById('costCode06GroupToggle');

      const totalCount = costCodeList.length;
      const selectedCount = selectedCostCodes.size;

      if (allToggle) {
        allToggle.indeterminate = selectedCount > 0 && selectedCount < totalCount;
        allToggle.checked = selectedCount === totalCount && totalCount > 0;
      }

      if (toggle09) {
        const codes09 = costCodeList.filter(code => code.startsWith('09'));
        const selected09 = codes09.filter(code => selectedCostCodes.has(code)).length;
        toggle09.indeterminate = selected09 > 0 && selected09 < codes09.length;
        toggle09.checked = codes09.length > 0 && selected09 === codes09.length;
      }

      if (toggle06Group) {
        const prefixes = ['06', '08', '10', '11', '12'];
        const codes06Group = costCodeList.filter(code => prefixes.some(prefix => code.startsWith(prefix)));
        const selected06Group = codes06Group.filter(code => selectedCostCodes.has(code)).length;
        toggle06Group.indeterminate = selected06Group > 0 && selected06Group < codes06Group.length;
        toggle06Group.checked = codes06Group.length > 0 && selected06Group === codes06Group.length;
      }
    }

    function renderJobList() {
      const list = document.getElementById('jobList');
      if (!list) return;

      if (!jobList.length) {
        list.innerHTML = '<div class="empty-filter">No jobs/buildings available.</div>';
        return;
      }

      list.innerHTML = '';

      jobList.forEach(job => {
        const label = document.createElement('label');
        label.className = 'checkbox chip';
        label.title = `Toggle ${job}`;

        const input = document.createElement('input');
        input.type = 'checkbox';
        input.value = job;
        input.checked = selectedJobs.has(job);
        input.addEventListener('change', handleJobToggle);

        label.appendChild(input);
        label.appendChild(document.createTextNode(` ${job}`));

        list.appendChild(label);
      });
    }

    function handleJobToggle(event) {
      const job = event.target.value;

      if (event.target.checked) {
        selectedJobs.add(job);
      } else {
        selectedJobs.delete(job);
      }

      updateJobMasterCheckboxes();
      updateChart();
    }

    function toggleAllJobs(event) {
      const shouldSelectAll = event.target.checked;

      if (shouldSelectAll) {
        selectedJobs = new Set(jobList);
      } else {
        selectedJobs.clear();
      }

      renderJobList();
      updateJobMasterCheckboxes();
      updateChart();
    }

    function updateJobMasterCheckboxes() {
      const allToggle = document.getElementById('jobAllToggle');
      const totalCount = jobList.length;
      const selectedCount = selectedJobs.size;

      if (allToggle) {
        allToggle.indeterminate = selectedCount > 0 && selectedCount < totalCount;
        allToggle.checked = totalCount > 0 && selectedCount === totalCount;
      }
    }

    function toggleFilterSection(sectionId, trigger) {
      const section = document.getElementById(sectionId);
      if (!section) return;

      const isHidden = section.classList.toggle('collapsed');
      section.style.display = isHidden ? 'none' : 'grid';
      if (trigger) {
        trigger.textContent = isHidden ? 'Show' : 'Hide';
        trigger.setAttribute('aria-expanded', (!isHidden).toString());
      }
    }

    function filterBySelectedCostCodes(data) {
      if (!selectedCostCodes.size) return [];

      return data.filter(entry => selectedCostCodes.has(normalizeCostCodeLabel(entry.cost_code)));
    }

    function filterBySelectedJobs(data) {
      if (!selectedJobs.size) return [];

      return data.filter(entry => selectedJobs.has(normalizeJobLabel(entry.job_description)));
    }

    function buildMonthlyEmployeeStats(entries) {
      if (!entries || !entries.length) return [];

      const monthlyMap = {};

      entries.forEach(entry => {
        const month = entry.date.substring(0, 7);

        if (!monthlyMap[month]) {
          monthlyMap[month] = { unique: new Set(), days: {} };
        }

        monthlyMap[month].unique.add(entry.employee_name);

        if (!monthlyMap[month].days[entry.date]) {
          monthlyMap[month].days[entry.date] = new Set();
        }
        monthlyMap[month].days[entry.date].add(entry.employee_name);
      });

      return Object.keys(monthlyMap)
        .sort()
        .map(month => {
          const dayCounts = Object.values(monthlyMap[month].days).map(set => set.size);
          const averageDailyEmployeesRaw = dayCounts.length
            ? dayCounts.reduce((sum, count) => sum + count, 0) / dayCounts.length
            : 0;

          return {
            month,
            employee_count: monthlyMap[month].unique.size,
            average_daily_employees: Number(averageDailyEmployeesRaw.toFixed(2))
          };
        });
    }

    function normalizeCostCodeLabel(code) {
      if (code === null || code === undefined) return 'Unknown';
      const normalized = code.toString().trim();
      return normalized || 'Unknown';
    }

    function normalizeJobLabel(job) {
      if (job === null || job === undefined) return 'Unknown';
      const normalized = job.toString().trim();
      return normalized || 'Unknown';
    }

    function renderTimeEntries() {
      const tbody = document.getElementById('entriesTableBody');
      
      if (timeEntries.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
              No time entries yet. Upload a payroll PDF to get started.
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = timeEntries.map(entry => `
        <tr style="border-bottom: 1px solid var(--border-color);">
          <td style="padding: 0.75rem;">${formatDate(entry.date)}</td>
          <td style="padding: 0.75rem;">${escapeHtml(entry.employee_name)}</td>
          <td style="padding: 0.75rem;">${entry.pay_class || '-'}</td>
          <td style="padding: 0.75rem; text-align: right;">${entry.hours.toFixed(2)}</td>
          <td style="padding: 0.75rem;">${entry.cost_code || '-'}</td>
          <td style="padding: 0.75rem; font-size: 0.813rem;">${entry.job_description || '-'}</td>
        </tr>
      `).join('');
    }

    function renderSummaryStats() {
      const totalHours = timeEntries.reduce((sum, entry) => sum + entry.hours, 0);
      const uniqueEmployees = new Set(timeEntries.map(e => e.employee_name)).size;
      const costCodes = new Set(timeEntries.map(e => e.cost_code).filter(Boolean)).size;

      const payClassTotals = timeEntries.reduce((acc, entry) => {
        const key = entry.pay_class || 'Unknown';
        acc[key] = (acc[key] || 0) + entry.hours;
        return acc;
      }, {});
      const payClassEntries = Object.entries(payClassTotals).sort((a, b) => b[1] - a[1]);

      const positiveHours = payClassEntries.map(([, hours]) => hours).filter(h => h > 0);
      const ratioBase = positiveHours.length ? Math.min(...positiveHours) : 0;
      const ratioText = ratioBase > 0
        ? payClassEntries.map(([name, hours]) => `${name}: ${Math.round(hours / ratioBase)}`).join(' ‚Ä¢ ')
        : 'No pay class hours available yet.';

      const dateRange = timeEntries.length > 0 ? {
        start: new Date(Math.min(...timeEntries.map(e => new Date(e.date)))),
        end: new Date(Math.max(...timeEntries.map(e => new Date(e.date))))
      } : null;

      document.getElementById('summaryStats').innerHTML = `
        <div style="display: grid; gap: 1rem;">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem;">
            <div>
              <div style="font-size: 1.875rem; font-weight: 700; color: var(--primary-color);">
                ${totalHours.toLocaleString(undefined, { maximumFractionDigits: 1 })}
              </div>
              <div style="color: var(--text-secondary); font-size: 0.875rem;">Total Hours</div>
            </div>
            <div>
              <div style="font-size: 1.875rem; font-weight: 700; color: var(--primary-color);">
                ${uniqueEmployees}
              </div>
              <div style="color: var(--text-secondary); font-size: 0.875rem;">Unique Employees</div>
            </div>
            <div>
              <div style="font-size: 1.875rem; font-weight: 700; color: var(--primary-color);">
                ${costCodes}
              </div>
              <div style="color: var(--text-secondary); font-size: 0.875rem;">Cost Codes</div>
            </div>
          </div>
          ${dateRange ? `
            <div style="margin-top: 0.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
              <div style="font-size: 0.875rem; color: var(--text-secondary);">
                ${formatDate(dateRange.start.toISOString().split('T')[0])} - ${formatDate(dateRange.end.toISOString().split('T')[0])}
              </div>
            </div>
          ` : ''}
          ${payClassEntries.length ? `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1.25rem; align-items: center;">
              <div style="display: grid; gap: 0.75rem;">
                <div style="font-weight: 600;">Hours by Pay Class</div>
                <div style="display: grid; gap: 0.5rem;">
                  ${payClassEntries.map(([name, hours]) => {
                    const percentage = totalHours > 0 ? (hours / totalHours) * 100 : 0;
                    return `
                      <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0.5rem; background: #f8fafc; border: 1px solid var(--border-color); border-radius: 0.35rem;">
                        <span style="font-weight: 600;">${escapeHtml(name)}</span>
                        <span style="font-size: 0.9rem; color: var(--text-secondary);">${hours.toFixed(2)} hrs (${percentage.toFixed(1)}%)</span>
                      </div>
                    `;
                  }).join('')}
                </div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);">Ratio (relative to smallest class): ${ratioText}</div>
              </div>
              <div style="min-height: 240px;">
                <canvas id="payClassChart" aria-label="Pay class doughnut chart"></canvas>
              </div>
            </div>
          ` : `<p style="color: var(--text-secondary);">No pay class data yet.</p>`}
        </div>
      `;

      if (payClassEntries.length) {
        renderPayClassChart(payClassEntries, totalHours);
      }
    }

    function renderUploads(uploads) {
      const container = document.getElementById('uploadHistory');
      
      if (uploads.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary);">No uploads yet</p>';
        return;
      }

      container.innerHTML = uploads.map(upload => `
        <div class="file-item">
          <div>
            <div style="font-weight: 500;">${escapeHtml(upload.filename)}</div>
            <div style="font-size: 0.813rem; color: var(--text-secondary);">
              ${new Date(upload.upload_date).toLocaleString()}
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderRecentUploads(uploads) {
      const container = document.getElementById('recentUploads');
      const recent = uploads.slice(0, 5);
      
      if (recent.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.875rem;">No uploads yet</p>';
        return;
      }

      container.innerHTML = recent.map(upload => `
        <div style="padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
          <div style="font-size: 0.875rem; font-weight: 500;">${escapeHtml(upload.filename)}</div>
          <div style="font-size: 0.75rem; color: var(--text-secondary);">
            ${new Date(upload.upload_date).toLocaleString()}
          </div>
        </div>
      `).join('');
    }

    function renderBudgetUploads(uploads) {
      const container = document.getElementById('budgetUploadHistory');
      const meta = document.getElementById('budgetVersionMeta');

      if (!uploads || uploads.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary);">No budget uploads yet</p>';
        if (meta) meta.textContent = 'No budget uploads yet';
        return;
      }

      if (meta) {
        const latest = uploads[0];
        meta.textContent = `Latest: ${escapeHtml(latest.filename)} ‚Ä¢ ${new Date(latest.upload_date).toLocaleString()} (${uploads.length} total)`;
      }

      container.innerHTML = uploads.map(upload => `
        <div class="file-item">
          <div>
            <div style="font-weight: 500;">${escapeHtml(upload.filename)}</div>
            <div style="font-size: 0.813rem; color: var(--text-secondary);">
              ${new Date(upload.upload_date).toLocaleString()}
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderBudgetSummary() {
      const summaryEl = document.getElementById('budgetSummary');
      const metaEl = document.getElementById('budgetMeta');

      if (!summaryEl || !metaEl) return;

      if (!budgetData || !budgetData.latest) {
        metaEl.textContent = 'No budget uploaded yet';
        summaryEl.innerHTML = '<p style="color: var(--text-secondary);">Upload a budget spreadsheet to compare against time entries.</p>';
        return;
      }

      const latest = budgetData.latest;
      metaEl.textContent = `Latest: ${escapeHtml(latest.filename)} ‚Ä¢ ${new Date(latest.upload_date).toLocaleString()}`;

      const totalBudgetHours = Object.values(latest.cost_code_hours || {}).reduce((sum, val) => sum + Number(val || 0), 0);
      const totalActualHours = budgetComparison.reduce((sum, row) => sum + (row.actual_hours || 0), 0);
      const totalVariance = totalActualHours - totalBudgetHours;

      const varianceRows = sortBudgetRows(budgetComparison);

      summaryEl.innerHTML = `
        <div style="display: grid; gap: 1rem;">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem;">
            <div>
              <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">${formatHours(totalBudgetHours)}</div>
              <div style="color: var(--text-secondary); font-size: 0.9rem;">Budgeted Hours</div>
            </div>
            <div>
              <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">${formatHours(totalActualHours)}</div>
              <div style="color: var(--text-secondary); font-size: 0.9rem;">Hours Spent</div>
            </div>
            <div>
              <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">${formatHours(totalVariance)}</div>
              <div style="color: var(--text-secondary); font-size: 0.9rem;">Variance (hrs)</div>
            </div>
          </div>
          ${varianceRows.length ? `
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="border-bottom: 2px solid var(--border-color);">
                    <th style="text-align: left; padding: 0.5rem;">
                      <button class="sort-button" type="button" onclick="changeBudgetSort('cost_code')">
                        Cost Code ${renderSortIndicator('cost_code')}
                      </button>
                    </th>
                    <th style="text-align: right; padding: 0.5rem;">
                      <button class="sort-button" type="button" onclick="changeBudgetSort('budget_hours')">
                        Budget ${renderSortIndicator('budget_hours')}
                      </button>
                    </th>
                    <th style="text-align: right; padding: 0.5rem;">
                      <button class="sort-button" type="button" onclick="changeBudgetSort('actual_hours')">
                        Spent ${renderSortIndicator('actual_hours')}
                      </button>
                    </th>
                    <th style="text-align: right; padding: 0.5rem;">
                      <button class="sort-button" type="button" onclick="changeBudgetSort('variance_hours')">
                        Variance ${renderSortIndicator('variance_hours')}
                      </button>
                    </th>
                    <th style="text-align: right; padding: 0.5rem;">
                      <button class="sort-button" type="button" onclick="changeBudgetSort('variance_percent')">
                        % Variance ${renderSortIndicator('variance_percent')}
                      </button>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  ${varianceRows.map(row => `
                    <tr style="border-bottom: 1px solid var(--border-color);">
                      <td style="padding: 0.5rem; font-weight: 600;">${escapeHtml(row.cost_code)}</td>
                      <td style="padding: 0.5rem; text-align: right;">${formatHours(row.budget_hours)}</td>
                      <td style="padding: 0.5rem; text-align: right;">${formatHours(row.actual_hours)}</td>
                      <td style="padding: 0.5rem; text-align: right;">${formatVarianceBadge(row.variance_hours)}</td>
                      <td style="padding: 0.5rem; text-align: right;">${formatPercentVariance(row.variance_percent)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          ` : '<p style="color: var(--text-secondary);">No budget variance to display yet.</p>'}
        </div>
      `;
    }

    function changeBudgetSort(column) {
      if (budgetSort.column === column) {
        budgetSort.direction = budgetSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        budgetSort = { column, direction: column === 'cost_code' ? 'asc' : 'desc' };
      }

      renderBudgetSummary();
      renderBudgetCharts();
    }

    function renderSortIndicator(column) {
      if (budgetSort.column !== column) return '';
      return budgetSort.direction === 'asc' ? '‚ñ≤' : '‚ñº';
    }

    function sortBudgetRows(rows = []) {
      const { column, direction } = budgetSort;
      const multiplier = direction === 'asc' ? 1 : -1;

      const getValue = (row) => {
        if (column === 'cost_code') return row.cost_code || '';
        if (column === 'budget_hours') return Number(row.budget_hours) || 0;
        if (column === 'actual_hours') return Number(row.actual_hours) || 0;
        if (column === 'variance_percent') return Number.isFinite(row.variance_percent) ? row.variance_percent : -Infinity;
        return Number(row.variance_hours) || 0;
      };

      return [...rows].sort((a, b) => {
        const aVal = getValue(a);
        const bVal = getValue(b);

        if (typeof aVal === 'string' || typeof bVal === 'string') {
          return aVal.localeCompare(bVal) * multiplier;
        }

        return (aVal - bVal) * multiplier;
      });
    }

    function renderBudgetBreakdown() {
      const container = document.getElementById('budgetBreakdown');
      if (!container) return;

      if (!budgetData || !budgetData.latest) {
        container.innerHTML = '<p style="color: var(--text-secondary);">Upload a budget and add time entries to see the breakdown.</p>';
        return;
      }

      const rows = [...budgetComparison].sort((a, b) => a.cost_code.localeCompare(b.cost_code));

      container.innerHTML = `
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 2px solid var(--border-color);">
                <th style="text-align: left; padding: 0.6rem;">Cost Code</th>
                <th style="text-align: right; padding: 0.6rem;">Budget Hours</th>
                <th style="text-align: right; padding: 0.6rem;">Hours Spent</th>
                <th style="text-align: right; padding: 0.6rem;">Variance (hrs)</th>
                <th style="text-align: right; padding: 0.6rem;">Variance (%)</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map(row => `
                <tr style="border-bottom: 1px solid var(--border-color);">
                  <td style="padding: 0.6rem; font-weight: 600;">${escapeHtml(row.cost_code)}</td>
                  <td style="padding: 0.6rem; text-align: right;">${formatHours(row.budget_hours)}</td>
                  <td style="padding: 0.6rem; text-align: right;">${formatHours(row.actual_hours)}</td>
                  <td style="padding: 0.6rem; text-align: right;">${formatVarianceBadge(row.variance_hours)}</td>
                  <td style="padding: 0.6rem; text-align: right;">${formatPercentVariance(row.variance_percent)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderBudgetCharts() {
      const varianceCanvas = document.getElementById('budgetVarianceChart');
      const chartMode = document.getElementById('budgetChartMode')?.value || 'hours';

      if (budgetChart) budgetChart.destroy();

      if (!budgetData || !budgetData.latest || !budgetComparison.length || !varianceCanvas) return;

      const sortedRows = sortBudgetRows(budgetComparison);
      const labels = sortedRows.map(row => row.cost_code);

      const values = sortedRows.map(row => {
        if (chartMode === 'percent') {
          return Number.isFinite(row.variance_percent) ? row.variance_percent : 0;
        }
        return row.variance_hours;
      });

      const colors = values.map((v, index) => {
        const rawValue = chartMode === 'percent'
          ? (Number.isFinite(sortedRows[index].variance_percent) ? sortedRows[index].variance_percent : 0)
          : sortedRows[index].variance_hours;
        return rawValue >= 0 ? 'rgba(239, 68, 68, 0.8)' : 'rgba(34, 197, 94, 0.8)';
      });

      const yLabel = chartMode === 'percent' ? 'Percent' : 'Hours';
      const dataLabel = chartMode === 'percent' ? 'Variance (%)' : 'Variance (hrs)';

      budgetChart = new Chart(varianceCanvas, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: dataLabel,
            data: values,
            backgroundColor: colors,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const row = sortedRows[context.dataIndex];
                  if (chartMode === 'percent') {
                    const percent = Number.isFinite(row.variance_percent) ? row.variance_percent.toFixed(1) + '%' : 'N/A';
                    return `${row.cost_code}: ${percent}`;
                  }
                  return `${row.cost_code}: ${formatHours(row.variance_hours)} hrs`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: yLabel }
            }
          }
        }
      });
    }

    function renderAreaSection() {
      renderAreaMappings();
      renderAreaComparison();
      renderAreaVarianceSummary();
    }

    function renderAreaMappings() {
      const container = document.getElementById('areaMappingList');
      if (!container) return;

      if (!areaData || !areaData.budgetAreas.length) {
        container.innerHTML = '<p style="color: var(--text-secondary);">Upload a budget with area names to start matching.</p>';
        return;
      }

      const options = areaData.actualAreas || [];
      const optionHtml = options.map(area => `<option value="${area.key}">${escapeHtml(area.label)} (${formatHours(area.hours)} hrs)</option>`).join('');

      container.innerHTML = areaData.budgetAreas.map(area => {
        const selected = areaData.mappings?.[area.key] || (options.find(o => o.key === area.key)?.key || '');
        return `
          <div class="file-item" style="align-items: center; gap: 0.75rem;">
            <div style="flex: 1;">
              <div style="font-weight: 600;">${escapeHtml(area.label)}</div>
              <div style="color: var(--text-secondary); font-size: 0.85rem;">${formatHours(area.hours)} budgeted hours</div>
            </div>
            <div>
              <label style="font-size: 0.85rem; color: var(--text-secondary);">Match to payroll job</label>
              <select onchange="handleAreaMappingChange('${area.key}', this.value)" style="margin-top: 0.35rem; padding: 0.4rem; min-width: 220px;">
                <option value="">Use budget name</option>
                ${optionHtml}
              </select>
            </div>
          </div>
        `;
      }).join('');

      // set selected values after rendering
      areaData.budgetAreas.forEach(area => {
        const select = container.querySelector(`select[onchange*="${area.key}"]`);
        if (select) {
          const selected = areaData.mappings?.[area.key] || (options.find(o => o.key === area.key)?.key || '');
          select.value = selected;
        }
      });
    }

    function renderAreaComparison() {
      const container = document.getElementById('areaComparison');
      if (!container) return;

      if (!areaData || !areaData.comparison || areaData.comparison.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary);">Upload a budget and add payroll entries to compare by building.</p>';
        return;
      }

      container.innerHTML = `
        <div style="overflow-x: auto;">
          <table class="area-table">
            <thead>
              <tr>
                <th class="area-cell">Area</th>
                <th class="number-cell">Budgeted</th>
                <th class="number-cell">Spent</th>
                <th class="number-cell">Variance</th>
                <th class="number-cell">Adjust budget</th>
                <th class="number-cell">Adjust spent</th>
              </tr>
            </thead>
            <tbody>
              ${areaData.comparison.map(row => `
                <tr>
                  <td class="area-cell">${escapeHtml(row.area)}</td>
                  <td class="number-cell">${formatHours(row.budget_hours)}</td>
                  <td class="number-cell">${formatHours(row.actual_hours)}</td>
                  <td class="variance-cell">
                    <div class="variance-value">${formatVarianceBadge(row.variance_hours)}</div>
                    <div class="variance-percent">${formatPercentVariance(row.variance_percent)}</div>
                  </td>
                  <td class="adjust-cell">
                    <div class="adjust-inputs">
                      <input type="number" step="0.1" data-adjust-input="budget-${row.key}" value="${areaData.adjustments?.budget?.[row.key] ?? ''}" aria-label="Adjust budget hours for ${escapeHtml(row.area)}">
                      <button class="chip" type="button" onclick="saveAreaAdjustment('${row.key}', 'budget')">Save</button>
                    </div>
                  </td>
                  <td class="adjust-cell">
                    <div class="adjust-inputs">
                      <input type="number" step="0.1" data-adjust-input="actual-${row.key}" value="${areaData.adjustments?.actual?.[row.key] ?? ''}" aria-label="Adjust spent hours for ${escapeHtml(row.area)}">
                      <button class="chip" type="button" onclick="saveAreaAdjustment('${row.key}', 'actual')">Save</button>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderAreaVarianceSummary() {
      const container = document.getElementById('areaVarianceSummary');
      if (!container) return;

      if (!areaData || !Array.isArray(areaData.comparison) || areaData.comparison.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary);">Upload a budget with area names to see variance by area.</p>';
        return;
      }

      const rows = [...areaData.comparison].sort((a, b) => a.area.localeCompare(b.area));

      container.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
          <h4 style="margin: 0;">Variance by area</h4>
          <span style="color: var(--text-secondary); font-size: 0.9rem;">From budget import areas</span>
        </div>
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 2px solid var(--border-color);">
                <th style="padding: 0.6rem; text-align: left;">Area</th>
                <th style="padding: 0.6rem; text-align: right;">Budgeted</th>
                <th style="padding: 0.6rem; text-align: right;">Spent</th>
                <th style="padding: 0.6rem; text-align: right;">Variance (hrs)</th>
                <th style="padding: 0.6rem; text-align: right;">Variance (%)</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map(row => `
                <tr style="border-bottom: 1px solid var(--border-color);">
                  <td style="padding: 0.6rem; font-weight: 600;">${escapeHtml(row.area)}</td>
                  <td style="padding: 0.6rem; text-align: right;">${formatHours(row.budget_hours)}</td>
                  <td style="padding: 0.6rem; text-align: right;">${formatHours(row.actual_hours)}</td>
                  <td style="padding: 0.6rem; text-align: right;">${formatVarianceBadge(row.variance_hours)}</td>
                  <td style="padding: 0.6rem; text-align: right;">${formatPercentVariance(row.variance_percent)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    async function handleAreaMappingChange(budgetKey, targetKey) {
      try {
        const response = await fetch(`/api/projects/${projectId}/areas/mappings`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mappings: { [budgetKey]: targetKey } })
        });
        if (response.ok) {
          areaData = await response.json();
          renderAreaSection();
        }
      } catch (error) {
        console.error('Error saving area mapping:', error);
      }
    }

    async function saveAreaAdjustment(areaKey, type) {
      const input = document.querySelector(`[data-adjust-input="${type}-${areaKey}"]`);
      if (!input) return;

      const value = parseFloat(input.value);
      const payload = type === 'budget'
        ? { budgetAdjustments: { [areaKey]: Number.isFinite(value) ? value : 0 } }
        : { actualAdjustments: { [areaKey]: Number.isFinite(value) ? value : 0 } };

      try {
        const response = await fetch(`/api/projects/${projectId}/areas/adjustments`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (response.ok) {
          areaData = await response.json();
          renderAreaSection();
        }
      } catch (error) {
        console.error('Error saving area adjustment:', error);
      }
    }

    function updateChart() {
      const viewType = document.getElementById('viewType').value;
      const stacked = document.getElementById('stackToggle').checked;
      const ctx = document.getElementById('hoursChart');
      const applyFilters = document.getElementById('applyFiltersToggle')?.checked !== false;

      toggleFilterPanelVisibility(true);

      const baseData = filterBySelectedJobs(filterBySelectedCostCodes(detailedStats));

      const hiddenStates = hoursChart
        ? hoursChart.data.datasets.map((ds, index) => ({ label: ds.label ?? index, hidden: ds.hidden }))
        : [];

      if (hoursChart) {
        hoursChart.destroy();
      }

      let chartData;

      if (viewType === 'total') {
        chartData = aggregateByMonth(baseData);
      } else if (viewType === 'costCode') {
        chartData = aggregateByCategory(baseData, 'cost_code');
      } else if (viewType === 'costCodeDivision') {
        chartData = aggregateByCategory(baseData, 'cost_code', formatCostCodeDivision);
      } else if (viewType === 'payClass') {
        chartData = aggregateByCategory(baseData, 'pay_class');
      } else if (viewType === 'job') {
        chartData = aggregateByCategory(baseData, 'job_description');
      } else if (viewType === 'employee') {
        chartData = aggregateByCategory(baseData, 'employee_name');
      }

      hoursChart = new Chart(ctx, {
        type: 'bar',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: viewType !== 'total'
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          },
          scales: {
            x: {
              stacked,
              grid: {
                display: false
              }
            },
            y: {
              stacked,
              beginAtZero: true,
              title: {
                display: true,
                text: 'Hours'
              }
            }
          }
        }
      });

      if (hiddenStates.length) {
        const hiddenMap = new Map(hiddenStates.map(state => [state.label, state.hidden]));
        hoursChart.data.datasets.forEach((dataset, index) => {
          const key = dataset.label ?? index;
          if (hiddenMap.has(key)) {
            dataset.hidden = hiddenMap.get(key);
          }
        });
        hoursChart.update();
      }

      renderEmployeeChart();
    }

    function aggregateByMonth(data) {
      const monthlyTotals = {};
      
      data.forEach(entry => {
        if (!monthlyTotals[entry.month]) {
          monthlyTotals[entry.month] = 0;
        }
        monthlyTotals[entry.month] += entry.total_hours;
      });

      const months = Object.keys(monthlyTotals).sort();
      const hours = months.map(m => monthlyTotals[m]);

      return {
        labels: months.map(formatMonth),
        datasets: [{
          label: 'Total Hours',
          data: hours,
          backgroundColor: 'rgba(37, 99, 235, 0.8)',
          borderColor: 'rgba(37, 99, 235, 1)',
          borderWidth: 1
        }]
      };
    }

    function aggregateByCategory(data, category, transformer = null) {
      const monthlyData = {};
      const categories = new Set();

      data.forEach(entry => {
        const rawValue = entry[category];
        const cat = transformer ? transformer(rawValue) : (rawValue || 'Unknown');
        categories.add(cat);
        
        if (!monthlyData[entry.month]) {
          monthlyData[entry.month] = {};
        }
        if (!monthlyData[entry.month][cat]) {
          monthlyData[entry.month][cat] = 0;
        }
        monthlyData[entry.month][cat] += entry.total_hours;
      });

      const months = Object.keys(monthlyData).sort();
      const colors = generateColors(categories.size);
      
      const datasets = Array.from(categories).map((cat, index) => ({
        label: cat,
        data: months.map(month => monthlyData[month][cat] || 0),
        backgroundColor: colors[index],
        borderWidth: 0
      }));

      return {
        labels: months.map(formatMonth),
        datasets
      };
    }

    function renderEmployeeChart() {
      const canvas = document.getElementById('employeeChart');
      if (!canvas) return;

      const metric = document.getElementById('employeeMetric')?.value || 'unique';
      const subtitle = document.getElementById('employeeChartSubtitle');
      const applyFilters = document.getElementById('employeeApplyFiltersToggle')?.checked;
      const emptyState = document.getElementById('employeeChartEmptyState');

      const stats = applyFilters
        ? buildMonthlyEmployeeStats(filterBySelectedJobs(filterBySelectedCostCodes(timeEntries)))
        : (monthlyStats || []).map(stat => ({
            month: stat.month,
            employee_count: Number(stat.employee_count) || 0,
            average_daily_employees: Number(stat.average_daily_employees) || 0
          }));

      if (!stats || stats.length === 0) {
        if (employeeChart) {
          employeeChart.destroy();
          employeeChart = null;
        }
        canvas.style.display = 'none';
        if (emptyState) {
          emptyState.style.display = 'block';
        }
        return;
      }

      canvas.style.display = 'block';
      if (emptyState) {
        emptyState.style.display = 'none';
      }

      if (employeeChart) {
        employeeChart.destroy();
      }

      const labels = stats.map(stat => formatMonth(stat.month));
      const counts = stats.map(stat => metric === 'average' ? stat.average_daily_employees : stat.employee_count);

      if (subtitle) {
        subtitle.textContent = metric === 'average'
          ? 'Average daily crew size per month'
          : 'Unique employees working each month';
      }

      employeeChart = new Chart(canvas, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: metric === 'average' ? 'Avg daily employees' : 'Employees',
            data: counts,
            borderColor: 'rgba(37, 99, 235, 1)',
            backgroundColor: 'rgba(37, 99, 235, 0.15)',
            borderWidth: 2,
            tension: 0.2,
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Employees' },
              ticks: { stepSize: 1 }
            },
            x: {
              grid: { display: false }
            }
          }
        }
      });
    }

    function formatCostCodeDivision(costCode) {
      if (!costCode) return 'Unknown';
      const trimmed = costCode.toString().trim();
      if (trimmed.length < 2) return trimmed || 'Unknown';
      return `${trimmed.slice(0, 2)} Division`;
    }

    function generateColors(count) {
      const colors = [
        'rgba(37, 99, 235, 0.8)',
        'rgba(34, 197, 94, 0.8)',
        'rgba(234, 179, 8, 0.8)',
        'rgba(239, 68, 68, 0.8)',
        'rgba(168, 85, 247, 0.8)',
        'rgba(236, 72, 153, 0.8)',
        'rgba(14, 165, 233, 0.8)',
        'rgba(251, 146, 60, 0.8)',
        'rgba(132, 204, 22, 0.8)',
        'rgba(249, 115, 22, 0.8)'
      ];
      
      while (colors.length < count) {
        colors.push(`rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 0.8)`);
      }

      return colors;
    }

    function renderPayClassChart(payClassEntries, totalHours) {
      const ctx = document.getElementById('payClassChart');
      if (!ctx) return;

      if (payClassChart) {
        payClassChart.destroy();
      }

      const labels = payClassEntries.map(([name]) => name);
      const data = payClassEntries.map(([, hours]) => hours);
      const colors = generateColors(labels.length);

      payClassChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: colors,
            borderWidth: 0
          }]
        },
        options: {
          plugins: {
            tooltip: {
              callbacks: {
                label: (context) => {
                  const hours = context.raw || 0;
                  const percent = totalHours > 0 ? (hours / totalHours) * 100 : 0;
                  return `${context.label}: ${hours.toFixed(2)} hrs (${percent.toFixed(1)}%)`;
                }
              }
            },
            legend: {
              position: 'bottom'
            }
          },
          cutout: '55%'
        }
      });
    }

    function setupUploadArea() {
      const uploadArea = document.getElementById('uploadArea');
      const fileInput = document.getElementById('fileInput');

      uploadArea.addEventListener('click', () => fileInput.click());

      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type === 'application/pdf') {
          uploadFile(files[0]);
        } else {
          alert('Please drop a PDF file');
        }
      });
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        uploadFile(file);
      }
    }

    async function uploadFile(file) {
      const formData = new FormData();
      formData.append('payroll', file);

      const progressDiv = document.getElementById('uploadProgress');
      const resultDiv = document.getElementById('uploadResult');
      
      progressDiv.style.display = 'block';
      resultDiv.innerHTML = '';

      try {
        const response = await fetch(`/api/projects/${projectId}/upload`, {
          method: 'POST',
          body: formData
        });

        const result = await response.json();
        progressDiv.style.display = 'none';

        if (response.ok) {
          resultDiv.innerHTML = `
            <div class="alert alert-success">
              ‚úì Successfully processed ${result.entriesInserted} time entries from ${result.entriesFound} found in the PDF
            </div>
          `;
          
          // Reload data
          await loadTimeEntries();
          await loadDetailedStats();
          await loadBudgetData();
          await loadUploads();
          updateChart();
          renderSummaryStats();
          
          // Reset file input
          document.getElementById('fileInput').value = '';
        } else {
          resultDiv.innerHTML = `
            <div class="alert alert-error">
              ‚úó Error: ${result.error || 'Failed to upload file'}
            </div>
          `;
        }
      } catch (error) {
        progressDiv.style.display = 'none';
        resultDiv.innerHTML = `
          <div class="alert alert-error">
            ‚úó Error uploading file: ${error.message}
          </div>
        `;
      }
    }

    function setupBudgetUploadArea() {
      const uploadArea = document.getElementById('budgetUploadArea');
      const fileInput = document.getElementById('budgetFileInput');

      if (!uploadArea || !fileInput) return;

      uploadArea.addEventListener('click', () => fileInput.click());

      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0 && isExcelFile(files[0])) {
          uploadBudgetFile(files[0]);
        } else {
          alert('Please drop an Excel file (.xlsx or .xls)');
        }
      });
    }

    function handleBudgetFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        uploadBudgetFile(file);
      }
    }

    function isExcelFile(file) {
      const acceptedTypes = [
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'application/vnd.ms-excel'
      ];
      return acceptedTypes.includes(file.type) || file.name.endsWith('.xlsx') || file.name.endsWith('.xls');
    }

    async function uploadBudgetFile(file) {
      const progressDiv = document.getElementById('budgetUploadProgress');
      const resultDiv = document.getElementById('budgetUploadResult');

      progressDiv.style.display = 'block';
      resultDiv.innerHTML = '';

      try {
        const { costCodeHours, areaHours } = await parseBudgetFile(file);

        const response = await fetch(`/api/projects/${projectId}/budget`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename: file.name, costCodeHours, areaHours })
        });

        const result = await response.json();
        progressDiv.style.display = 'none';

        if (response.ok) {
          budgetData = result;
          budgetComparison = result.comparison || [];
          renderBudgetSummary();
          renderBudgetUploads(result.uploads || []);
          renderBudgetBreakdown();
          renderBudgetCharts();
          areaData = result.areaComparison || areaData;
          renderAreaSection();

          resultDiv.innerHTML = `
            <div class="alert alert-success">
              ‚úì Processed ${result.codesTracked} cost codes from ${escapeHtml(file.name)}
            </div>
          `;

          document.getElementById('budgetFileInput').value = '';
        } else {
          resultDiv.innerHTML = `
            <div class="alert alert-error">
              ‚úó Error: ${result.error || 'Failed to save budget'}
            </div>
          `;
        }
      } catch (error) {
        progressDiv.style.display = 'none';
        resultDiv.innerHTML = `
          <div class="alert alert-error">
            ‚úó Error processing budget: ${error.message}
          </div>
        `;
      }
    }

    // Budget parser: reads cost codes from column B, hours from column I, and tracks areas based on job numbers in column B + area names in column C
    async function parseBudgetFile(file) {
      if (typeof XLSX === 'undefined') {
        throw new Error('Spreadsheet parser not available.');
      }

      const buffer = await file.arrayBuffer();
      const workbook = XLSX.read(buffer, { type: 'array' });

      // Use first sheet (should be the budget sheet)
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

      if (!rows.length) {
        throw new Error('The spreadsheet is empty.');
      }

      // Column B is index 1 (0-based), Column I is index 8
      const costCodeIndex = 1; // Column B
      const hoursIndex = 8; // Column I
      const areaNameIndex = 2; // Column C contains building/area names when paired with a job number in column B

      const totals = {};
      const areaTotals = {};
      let rowsProcessed = 0;
      let currentArea = null;
      let mainJobPrefix = null;

      const looksLikeJobNumber = (value) => {
        if (value === undefined || value === null) return false;
        return /^\d+(?:\.\d+)?$/.test(value.toString().trim());
      };

      // Start from row 1 to skip any header rows
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (!row || row.length <= Math.max(costCodeIndex, hoursIndex)) continue;

        const rawCode = row[costCodeIndex];
        const rawHours = row[hoursIndex];

        // Capture the overall job prefix (first 4 digits) when we see a "Job" label row
        if (typeof rawCode === 'string' && rawCode.trim().toLowerCase() === 'job') {
          const possibleJobNumber = row[areaNameIndex];
          if (looksLikeJobNumber(possibleJobNumber)) {
            const jobDigits = possibleJobNumber.toString().trim().replace(/[^0-9]/g, '');
            mainJobPrefix = jobDigits.slice(0, 4) || null;
          }
          continue;
        }

        // Capture the current area when we encounter a job number in column B with a name in column C
        if (looksLikeJobNumber(rawCode) && row[areaNameIndex]) {
          const jobDigits = rawCode.toString().trim().replace(/[^0-9]/g, '');
          const matchesMainJob = mainJobPrefix ? jobDigits.startsWith(mainJobPrefix) : true;

          if (!matchesMainJob) {
            continue;
          }

          const areaLabel = row[areaNameIndex].toString().trim();
          if (areaLabel && !areaLabel.toLowerCase().includes('total')) {
            currentArea = areaLabel;
          }
          continue;
        }

        // Skip if either value is missing or empty
        if (!rawCode || rawCode === '') continue;

        // Skip "Total" rows (cost code contains "Total")
        const codeStr = rawCode.toString().trim();
        if (codeStr.toLowerCase().includes('total')) continue;

        // Skip division header rows (cost codes without dashes like "01", "06", "07")
        if (codeStr.match(/^\d{2}$/)) continue;

        const hours = parseFloat(rawHours);
        const normalizedCode = normalizeCostCodeClient(rawCode);

        // Only process if we have a valid cost code and numeric hours
        if (!normalizedCode || !Number.isFinite(hours)) continue;

        totals[normalizedCode] = (totals[normalizedCode] || 0) + hours;

        if (currentArea) {
          areaTotals[currentArea] = (areaTotals[currentArea] || 0) + hours;
        }

        rowsProcessed++;
      }

      if (Object.keys(totals).length === 0) {
        throw new Error(`No valid cost codes with labor hours were found. Processed ${rowsProcessed} rows from sheet "${sheetName}".`);
      }

      console.log(
        `Successfully parsed ${Object.keys(totals).length} unique cost codes from ${rowsProcessed} rows in sheet "${sheetName}"`
      );
      return { costCodeHours: totals, areaHours: areaTotals };
    }

    function switchTab(evt, tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      if (evt && evt.target) {
        evt.target.classList.add('active');
      }

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName + 'Tab').classList.add('active');
    }

    // Normalize cost codes to numeric-only strings (drops decimals)
    function normalizeCostCodeClient(code) {
      if (code === undefined || code === null) return null;
      const [mainPart] = code.toString().split('.');
      const numeric = mainPart.replace(/\D/g, '').trim();
      return numeric || null;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr + 'T00:00:00');
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function formatMonth(monthStr) {
      const [year, month] = monthStr.split('-');
      const date = new Date(year, month - 1);
      return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
    }

    function formatHours(value) {
      return Number(value || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatVarianceBadge(value) {
      const sign = value > 0 ? '+' : '';
      const color = value > 0 ? '#ef4444' : value < 0 ? '#22c55e' : '#0f172a';
      return `<span style="font-weight: 700; color: ${color};">${sign}${Number(value || 0).toFixed(2)}</span>`;
    }

    function formatPercentVariance(value) {
      if (value === null || value === undefined || Number.isNaN(value)) return '‚Äî';
      const sign = value > 0 ? '+' : '';
      return `${sign}${value.toFixed(1)}%`;
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Search functionality
    document.getElementById('searchEntries').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#entriesTableBody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });
  </script>
</body>
</html>
